@using Microsoft.AspNetCore.SignalR.Client
@using MudBlazorPWA.Shared.Models
@using MudBlazorPWA.Shared.Extensions
@inject NavigationManager Navigation
<MudTreeView
    ServerData="LoadServerData"
    Items="TreeItems"
    ExpandOnClick="true"
    Hover="true">
  <ItemTemplate>
    <MudTreeViewItem
        Value="@context"
        Icon="@context.Icon"
        LoadingIconColor="Color.Info"
        CanExpand="@context.CanExpand"
        Text="@context.Title"
        EndText="@context.Number?.ToString()"
        EndTextTypo="@Typo.caption"/>
    @* OnClick="() => GetFolderContent(context)" *@
  </ItemTemplate>
</MudTreeView>

@code{
  private string? _rootDirectoryPath;
  private HashSet<TreeItemData> TreeItems { get; set; } = new HashSet<TreeItemData>();
  private TreeItemData? CurrentTreeItemData { get; set; }

  private HubConnection? _directoryHub;

  protected override async Task OnInitializedAsync() {
    await InitializeDirectoryHub();
  }

  private async Task InitializeDirectoryHub() {
    _directoryHub = new HubConnectionBuilder()
      .WithUrl(Navigation.ToAbsoluteUri("/directoryHub"))
      .Build();

    _directoryHub.On<string, string[]?, string[]?>("ReceiveFolderContent", (path, files, folders) => {
      _rootDirectoryPath ??= path;
      ConvertToTreeItems(path, files, folders);
      StateHasChanged();
    });

    await _directoryHub.StartAsync();
    await _directoryHub.SendAsync("GetFolderContent", null);
  }

  private Task ConvertToTreeItems(string path, string[]? files, string[]? folders) {
    if (folders != null) {
      foreach (var folder in folders) {
        var folderPath = folder.Replace(_rootDirectoryPath!, "");
        CurrentTreeItemData = new(folderPath, Icons.Material.Outlined.Folder, 20, true) {
          TreeItems = new()
        };
        TreeItems.Add(CurrentTreeItemData);
      }
    }


  // ReSharper disable once InvertIf
    if (files != null) {
      foreach (var file in files) {
        var filePath = file.Replace(_rootDirectoryPath!, "");
        CurrentTreeItemData = new(title: filePath, icon: Icons.Material.Outlined.PictureAsPdf, canExpand: false);
        TreeItems.Add(CurrentTreeItemData); }
      }
    return Task.CompletedTask;
  }

  //TODO: NO WORKEEEEEEEYYYYY
  private async Task<HashSet<TreeItemData>> LoadServerData(TreeItemData parentNode) {
  // return the updated TreeItems property
    CurrentTreeItemData = parentNode;
    var currentPath = _rootDirectoryPath + parentNode.Title;
    await _directoryHub!
      .SendAsync("GetFolderContent", currentPath);
    return CurrentTreeItemData.TreeItems;
  }

}
